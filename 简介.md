## 简介

这个doc主要梳理零售业务相关的一些内容以及常见问题的解决办法

### 店铺

零售店铺主要分为3种

- 单店版

  既有门店，也有网店。只是一个店铺，没有总店和分店的概念

- 大网店

  总店是只有网店的，没有门店。分店是只有门店的.(优衣库)

- 多网店

  总店是没有门店和网店的，分店是有门店和网店的.(盒马鲜生)

### 会员和客户

#### 区别

- 会员是客户的一个子集，是会员一定是客户，是客户不一定是会员

#### 来源和归属

客户的归属为总部，属于总部的资产。来源为首次发生关系的店铺(消费/公众号关注等等)。

会员的归属为总部，属于总部的资产。来源为入会时的店铺。


#### 渠道(线上 or 线下)


目前只有客户可以区分来源渠道是线上还是线下(关联表ods.retail_customer_sales),会员区分来源渠道也从客户这边来区分


#### 存在的问题

##### 会员来源渠道问题

由于会员来源渠道通过客户的来源进行判断，比如说一个大网店模式下的门店可能会有线上渠道的新增会员，这种情况就是客户来源为线上，但是入会是在线下

### 库存

#### 多网店下单订单不关联库存

##### 如何判断店铺是否开通多网店?

##### 通过表(ods.op_open_application_status)进行判断

```sql
// 558为多网店应用名
select *
from ods.op_open_application_status
where kdt_id = '40807753' and app_id = 558

```

##### 通过商家后台进行查看

归属网点存在多个代表开通了多网点

![image-20181206154113699](https://doc.qima-inc.com/download/attachments/123210369/image-20181206154113699.png?version=1&modificationDate=1545212626000&api=v2)



库存扣减规则可以参考链接:https://doc.qima-inc.com/pages/viewpage.action?pageId=27949532

ods.sc_goods_sku_order_deduct_log表中offline_id>0的为多网点

##### 如何查看店铺订单是否关联库存？

执行下面的sql，看stock_related_mode的值(库存关联模式; 不关联库存:0, 关联库存:1)

offline_id > 0 代表多网点

```sql
select offline_id,stock_related_mode,count(1) as cnt  
from ods.sc_goods_sku_order_deduct_log a
inner join dw.dwb_retail_order_retail_sku_fact b on a.order_no = b.order_no
where b.kdt_id  = 41465687 and b.dc_date between '20181101' and '20181130'
group by a.offline_id,a.stock_related_mode
```

![image-20181213153446867](https://doc.qima-inc.com/download/attachments/123210369/image-20181206160936658.png?version=1&modificationDate=1545212686000&api=v2)

### 商品

#### 商品中心的goods如何获取类目？

商品中心存在一张表`ods.ic_item_extra`,item_id即goods_id,可以执行如下的sql查看goods对应的category_id或name

```sql
select a.goods_id,b.attr_value as category_id,c.name
from dw.dwb_retail_goods_dim a 
left join ods.ic_item_extra b on a.goods_id  = b.item_id and b.attr_key = 'categoryId'
left join ods.retail_category c on b.attr_value = cast(c.category_id as varchar)
where a.goods_id = 438610568
group by a.goods_id,b.attr_value,c.name;

```

#### 商品中心的sku如何与零售sku进行关联？

只有当在库存侧进行库存扣减(表ods.sc_goods_sku_relation_deduct_log)，才能将商品中心的sku和零售的sku进行关联.

- order_item存在与deduct_log一对多的情况(例如大礼包、多扣减的商品)

  例如下面的商品是一杯拿铁咖啡，但是对应的库存扣减拥有6条记录.

  ![image-20181206160739594](https://doc.qima-inc.com/download/attachments/123210369/image-20181213153446867.png?version=1&modificationDate=1545212655000&api=v2)


![image-20181206160936658](https://doc.qima-inc.com/download/attachments/123210369/image-20181206160739594.png?version=1&modificationDate=1545212673000&api=v2)



#### 不扣减库存的情况

- 多网点下单商品不扣减库存
- 第三方商品不扣减库存
- 秒杀商品扣减UMP库存，无法关联到零售侧的sku
- 虚拟商品(例如会员卡也是不关联库存的)
  ![image-20181206160936659](https://doc.qima-inc.com/download/attachments/123210369/image2018-12-21_13-32-23.png?version=1&modificationDate=1545370343598&api=v2)


## 常见问题梳理

#### 商品毛利报表和商品销售报表不一致问题

##### 现象

商品毛利报表的销售金额或者数量和商品销售报表不一致.

##### 原因

商品/店铺毛利报表的数据源是库存的数据，商品销售数据的数据源是交易数据。交易那边下单了，但是不一定进行了发货(库存没扣)，因此会出现两边的不一致，这两个报表的数据核对本身也不具有意义的。

##### 参考

可以参考这个jira [ONLINE-57401](https://jira.qima-inc.com/browse/ONLINE-57401)